

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>ibllib.qc.camera &mdash; IBL Library  documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/copybutton.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/style.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
        <script src="../_static/clipboard.min.js"></script>
        <script src="../_static/copybutton.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="ibllib.qc.critical_reasons" href="ibllib.qc.critical_reasons.html" />
    <link rel="prev" title="ibllib.qc.base" href="ibllib.qc.base.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home" alt="Documentation Home"> IBL Library
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../01_overview.html">IBL data structure</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../02_installation.html">Installation</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../03_one.html">ONE</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../04_datajoint.html">Datajoint</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../05_tutorials.html">Tutorials</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../06_examples.html">Examples</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../07_public.html">IBL Public Data</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../08_contribution.html">Contribution Statement</a></li>
</ul>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../09_api_reference.html">API Reference</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="alf.html">alf</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="ibllib.html">ibllib</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="ibllib.atlas.html">ibllib.atlas</a></li>
<li class="toctree-l3"><a class="reference internal" href="ibllib.dsp.html">ibllib.dsp</a></li>
<li class="toctree-l3"><a class="reference internal" href="ibllib.ephys.html">ibllib.ephys</a></li>
<li class="toctree-l3"><a class="reference internal" href="ibllib.exceptions.html">ibllib.exceptions</a></li>
<li class="toctree-l3"><a class="reference internal" href="ibllib.graphic.html">ibllib.graphic</a></li>
<li class="toctree-l3"><a class="reference internal" href="ibllib.io.html">ibllib.io</a></li>
<li class="toctree-l3"><a class="reference internal" href="ibllib.misc.html">ibllib.misc</a></li>
<li class="toctree-l3"><a class="reference internal" href="ibllib.pipes.html">ibllib.pipes</a></li>
<li class="toctree-l3"><a class="reference internal" href="ibllib.plots.html">ibllib.plots</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="ibllib.qc.html">ibllib.qc</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="ibllib.qc.alignment_qc.html">ibllib.qc.alignment_qc</a></li>
<li class="toctree-l4"><a class="reference internal" href="ibllib.qc.base.html">ibllib.qc.base</a></li>
<li class="toctree-l4 current"><a class="current reference internal" href="#">ibllib.qc.camera</a></li>
<li class="toctree-l4"><a class="reference internal" href="ibllib.qc.critical_reasons.html">ibllib.qc.critical_reasons</a></li>
<li class="toctree-l4"><a class="reference internal" href="ibllib.qc.dlc.html">ibllib.qc.dlc</a></li>
<li class="toctree-l4"><a class="reference internal" href="ibllib.qc.oneqc_metrics.html">ibllib.qc.oneqc_metrics</a></li>
<li class="toctree-l4"><a class="reference internal" href="ibllib.qc.qcplots.html">ibllib.qc.qcplots</a></li>
<li class="toctree-l4"><a class="reference internal" href="ibllib.qc.task_extractors.html">ibllib.qc.task_extractors</a></li>
<li class="toctree-l4"><a class="reference internal" href="ibllib.qc.task_metrics.html">ibllib.qc.task_metrics</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="ibllib.tests.html">ibllib.tests</a></li>
<li class="toctree-l3"><a class="reference internal" href="ibllib.time.html">ibllib.time</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="oneibl.html">oneibl</a></li>
<li class="toctree-l2"><a class="reference internal" href="brainbox.html">brainbox</a></li>
</ul>
</li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">IBL Library</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../09_api_reference.html">API Reference</a> &raquo;</li>
        
          <li><a href="ibllib.html">ibllib</a> &raquo;</li>
        
          <li><a href="ibllib.qc.html">ibllib.qc</a> &raquo;</li>
        
      <li>ibllib.qc.camera</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/_autosummary/ibllib.qc.camera.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<div class="section" id="module-ibllib.qc.camera">
<span id="ibllib-qc-camera"></span><h1>ibllib.qc.camera<a class="headerlink" href="#module-ibllib.qc.camera" title="Permalink to this headline">¶</a></h1>
<p>Camera QC
This module runs a list of quality control metrics on the camera and extracted video data.</p>
<dl class="simple">
<dt>Example - Run right camera QC, downloading all but video file</dt><dd><p>qc = CameraQC(eid, ‘right’, download_data=True, stream=True)
qc.run()</p>
</dd>
<dt>Example - Run left camera QC with session path, update QC field in Alyx</dt><dd><p>qc = CameraQC(session_path, ‘left’)
outcome, extended = qc.run(update=True)  # Returns outcome of videoQC only
print(f’video QC = {outcome}; overall session QC = {qc.outcome}’)  # NB difference outcomes</p>
</dd>
<dt>Example - Run only video QC (no timestamp/alignment checks) on 20 frames for the body camera</dt><dd><p>qc = CameraQC(eid, ‘body’, n_samples=20)
qc.load_video_data()  # Quicker than loading all data
qc.run()</p>
</dd>
<dt>Example - Run specific video QC check and display the plots</dt><dd><p>qc = CameraQC(eid, ‘left;)
qc.load_data(download_data=True)
qc.check_position(display=True)  # NB: Not all checks make plots</p>
</dd>
<dt>Example - Run the QC for all cameras</dt><dd><p>qcs = run_all_qc(eid)
qcs[‘left’].metrics  # Dict of checks and outcomes for left camera</p>
</dd>
</dl>
<p class="rubric">Functions</p>
<table class="longtable docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<tbody>
<tr class="row-odd"><td><p><a class="reference internal" href="#ibllib.qc.camera.data_for_keys" title="ibllib.qc.camera.data_for_keys"><code class="xref py py-obj docutils literal notranslate"><span class="pre">data_for_keys</span></code></a></p></td>
<td><p>Check keys exist in ‘data’ dict and contain values other than None</p></td>
</tr>
<tr class="row-even"><td><p><a class="reference internal" href="#ibllib.qc.camera.run_all_qc" title="ibllib.qc.camera.run_all_qc"><code class="xref py py-obj docutils literal notranslate"><span class="pre">run_all_qc</span></code></a></p></td>
<td><p>Run QC for all cameras Run the camera QC for left, right and body cameras.</p></td>
</tr>
</tbody>
</table>
<p class="rubric">Classes</p>
<table class="longtable docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<tbody>
<tr class="row-odd"><td><p><a class="reference internal" href="#ibllib.qc.camera.CameraQC" title="ibllib.qc.camera.CameraQC"><code class="xref py py-obj docutils literal notranslate"><span class="pre">CameraQC</span></code></a></p></td>
<td><p>A class for computing camera QC metrics</p></td>
</tr>
</tbody>
</table>
<dl class="py class">
<dt id="ibllib.qc.camera.CameraQC">
<em class="property">class </em><code class="sig-name descname">CameraQC</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">session_path_or_eid</span></em>, <em class="sig-param"><span class="n">camera</span></em>, <em class="sig-param"><span class="o">**</span><span class="n">kwargs</span></em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/ibllib/qc/camera.html#CameraQC"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#ibllib.qc.camera.CameraQC" title="Permalink to this definition">¶</a></dt>
<dd><p>Bases: <a class="reference internal" href="ibllib.qc.base.html#ibllib.qc.base.QC" title="ibllib.qc.base.QC"><code class="xref py py-class docutils literal notranslate"><span class="pre">ibllib.qc.base.QC</span></code></a></p>
<p>A class for computing camera QC metrics</p>
<dl class="py attribute">
<dt id="ibllib.qc.camera.CameraQC.dstypes">
<code class="sig-name descname">dstypes</code><em class="property"> = ['_iblrig_Camera.frame_counter', '_iblrig_Camera.GPIO', '_iblrig_Camera.timestamps', '_iblrig_taskData.raw', '_iblrig_taskSettings.raw', '_iblrig_Camera.raw', 'camera.times', 'wheel.position', 'wheel.timestamps']</em><a class="headerlink" href="#ibllib.qc.camera.CameraQC.dstypes" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py attribute">
<dt id="ibllib.qc.camera.CameraQC.dstypes_fpga">
<code class="sig-name descname">dstypes_fpga</code><em class="property"> = ['_spikeglx_sync.channels', '_spikeglx_sync.polarities', '_spikeglx_sync.times', 'ephysData.raw.meta', 'ephysData.raw.wiring']</em><a class="headerlink" href="#ibllib.qc.camera.CameraQC.dstypes_fpga" title="Permalink to this definition">¶</a></dt>
<dd><p>Recall that for the training rig there is only one side camera at 30 Hz and 1280 x 1024 px.
For the recording rig there are two label cameras (left: 60 Hz, 1280 x 1024 px;
right: 150 Hz, 640 x 512 px) and one body camera (30 Hz, 640 x 512 px).</p>
</dd></dl>

<dl class="py attribute">
<dt id="ibllib.qc.camera.CameraQC.video_meta">
<code class="sig-name descname">video_meta</code><em class="property"> = {'ephys': {'body': {'fps': 30, 'height': 512, 'width': 640}, 'left': {'fps': 60, 'height': 1024, 'width': 1280}, 'right': {'fps': 150, 'height': 512, 'width': 640}}, 'training': {'left': {'fps': 30, 'height': 1024, 'width': 1280}}}</em><a class="headerlink" href="#ibllib.qc.camera.CameraQC.video_meta" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py method">
<dt id="ibllib.qc.camera.CameraQC.type">
<em class="property">property </em><code class="sig-name descname">type</code><a class="headerlink" href="#ibllib.qc.camera.CameraQC.type" title="Permalink to this definition">¶</a></dt>
<dd><p>Returns the camera type based on the protocol.
:return: Returns either None, ‘ephys’ or ‘training’</p>
</dd></dl>

<dl class="py method">
<dt id="ibllib.qc.camera.CameraQC.load_data">
<code class="sig-name descname">load_data</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">download_data</span><span class="p">:</span> <span class="n">bool</span> <span class="o">=</span> <span class="default_value">None</span></em>, <em class="sig-param"><span class="n">extract_times</span><span class="p">:</span> <span class="n">bool</span> <span class="o">=</span> <span class="default_value">False</span></em>, <em class="sig-param"><span class="n">load_video</span><span class="p">:</span> <span class="n">bool</span> <span class="o">=</span> <span class="default_value">True</span></em><span class="sig-paren">)</span> &#x2192; None<a class="reference internal" href="../_modules/ibllib/qc/camera.html#CameraQC.load_data"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#ibllib.qc.camera.CameraQC.load_data" title="Permalink to this definition">¶</a></dt>
<dd><p>Extract the data from raw data files
Extracts all the required task data from the raw data files.</p>
<dl class="simple">
<dt>Data keys:</dt><dd><ul class="simple">
<li><p>count (int array): the sequential frame number (n, n+1, n+2…)</p></li>
<li><p>pin_state (): the camera GPIO pin; records the audio TTLs; should be one per frame</p></li>
<li><p>audio (float array): timestamps of audio TTL fronts</p></li>
<li><p>fpga_times (float array): timestamps of camera TTLs recorded by FPGA</p></li>
<li><p>timestamps (float array): extracted video timestamps (the camera.times ALF)</p></li>
<li><p>bonsai_times (datetime array): system timestamps of video PC; should be one per frame</p></li>
<li><p>camera_times (float array): camera frame timestamps extracted from frame headers</p></li>
<li><p>wheel (Bunch): rotary encoder timestamps, position and period used for wheel motion</p></li>
<li><p>video (Bunch): video meta data, including dimensions and FPS</p></li>
<li><p>frame_samples (h x w x n array): array of evenly sampled frames (1 colour channel)</p></li>
</ul>
</dd>
</dl>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>download_data</strong> – if True, any missing raw data is downloaded via ONE.</p></li>
<li><p><strong>extract_times</strong> – if True, the camera.times are re-extracted from the raw data</p></li>
<li><p><strong>load_video</strong> – if True, calls the load_video_data method</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt id="ibllib.qc.camera.CameraQC.load_video_data">
<code class="sig-name descname">load_video_data</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="../_modules/ibllib/qc/camera.html#CameraQC.load_video_data"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#ibllib.qc.camera.CameraQC.load_video_data" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py method">
<dt id="ibllib.qc.camera.CameraQC.get_active_wheel_period">
<em class="property">static </em><code class="sig-name descname">get_active_wheel_period</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">wheel</span></em>, <em class="sig-param"><span class="n">range</span><span class="o">=</span><span class="default_value">3.0, 20.0</span></em>, <em class="sig-param"><span class="n">display</span><span class="o">=</span><span class="default_value">False</span></em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/ibllib/qc/camera.html#CameraQC.get_active_wheel_period"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#ibllib.qc.camera.CameraQC.get_active_wheel_period" title="Permalink to this definition">¶</a></dt>
<dd><p>Attempts to find a period of movement where the wheel accelerates and decelerates for
the wheel motion alignment QC.
:param wheel: A Bunch of wheel timestamps and position data
:param range: The candidates must be within min/max duration range
:return: 2-element array comprising the start and end times of the active period</p>
</dd></dl>

<dl class="py method">
<dt id="ibllib.qc.camera.CameraQC.run">
<code class="sig-name descname">run</code><span class="sig-paren">(</span><em class="sig-param">update: bool = False</em>, <em class="sig-param">**kwargs) -&gt; (&lt;class 'str'&gt;</em>, <em class="sig-param">&lt;class 'dict'&gt;</em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/ibllib/qc/camera.html#CameraQC.run"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#ibllib.qc.camera.CameraQC.run" title="Permalink to this definition">¶</a></dt>
<dd><p>Run video QC checks and return outcome
:param update: if True, updates the session QC fields on Alyx
:param download_data: if True, downloads any missing data if required
:param extract_times: if True, re-extracts the camera timestamps from the raw data
:returns: overall outcome as a str, a dict of checks and their outcomes</p>
</dd></dl>

<dl class="py method">
<dt id="ibllib.qc.camera.CameraQC.check_brightness">
<code class="sig-name descname">check_brightness</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">bounds</span><span class="o">=</span><span class="default_value">40, 200</span></em>, <em class="sig-param"><span class="n">max_std</span><span class="o">=</span><span class="default_value">20</span></em>, <em class="sig-param"><span class="n">display</span><span class="o">=</span><span class="default_value">False</span></em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/ibllib/qc/camera.html#CameraQC.check_brightness"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#ibllib.qc.camera.CameraQC.check_brightness" title="Permalink to this definition">¶</a></dt>
<dd><p>Check that the video brightness is within a given range
The mean brightness of each frame must be with the bounds provided, and the standard
deviation across samples frames should be less then the given value.  Assumes that the
frame samples are 2D (no colour channels).</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>bounds</strong> – For each frame, check that: bounds[0] &lt; M &lt; bounds[1], where M = mean(frame)</p></li>
<li><p><strong>max_std</strong> – The standard deviation of the frame luminance means must be less than this</p></li>
<li><p><strong>display</strong> – When True the mean frame luminance is plotted against sample frames.</p></li>
</ul>
</dd>
</dl>
<p>The sample frames with the lowest and highest mean luminance are shown.</p>
</dd></dl>

<dl class="py method">
<dt id="ibllib.qc.camera.CameraQC.check_file_headers">
<code class="sig-name descname">check_file_headers</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="../_modules/ibllib/qc/camera.html#CameraQC.check_file_headers"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#ibllib.qc.camera.CameraQC.check_file_headers" title="Permalink to this definition">¶</a></dt>
<dd><p>Check reported frame rate matches FPGA frame rate</p>
</dd></dl>

<dl class="py method">
<dt id="ibllib.qc.camera.CameraQC.check_framerate">
<code class="sig-name descname">check_framerate</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">threshold</span><span class="o">=</span><span class="default_value">1.0</span></em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/ibllib/qc/camera.html#CameraQC.check_framerate"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#ibllib.qc.camera.CameraQC.check_framerate" title="Permalink to this definition">¶</a></dt>
<dd><p>Check camera times match specified frame rate for camera</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><p><strong>threshold</strong> – The maximum absolute difference between timestamp sample rate and video</p>
</dd>
</dl>
<p>frame rate.  NB: Does not take into account dropped frames.</p>
</dd></dl>

<dl class="py method">
<dt id="ibllib.qc.camera.CameraQC.check_pin_state">
<code class="sig-name descname">check_pin_state</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">display</span><span class="o">=</span><span class="default_value">False</span></em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/ibllib/qc/camera.html#CameraQC.check_pin_state"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#ibllib.qc.camera.CameraQC.check_pin_state" title="Permalink to this definition">¶</a></dt>
<dd><p>Check the pin state reflects Bpod TTLs</p>
</dd></dl>

<dl class="py method">
<dt id="ibllib.qc.camera.CameraQC.check_dropped_frames">
<code class="sig-name descname">check_dropped_frames</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">threshold</span><span class="o">=</span><span class="default_value">0.1</span></em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/ibllib/qc/camera.html#CameraQC.check_dropped_frames"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#ibllib.qc.camera.CameraQC.check_dropped_frames" title="Permalink to this definition">¶</a></dt>
<dd><p>Check how many frames were reported missing</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><p><strong>threshold</strong> – The maximum allowable percentage of dropped frames</p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt id="ibllib.qc.camera.CameraQC.check_timestamps">
<code class="sig-name descname">check_timestamps</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="../_modules/ibllib/qc/camera.html#CameraQC.check_timestamps"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#ibllib.qc.camera.CameraQC.check_timestamps" title="Permalink to this definition">¶</a></dt>
<dd><p>Check that the camera.times array is reasonable</p>
</dd></dl>

<dl class="py method">
<dt id="ibllib.qc.camera.CameraQC.check_camera_times">
<code class="sig-name descname">check_camera_times</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="../_modules/ibllib/qc/camera.html#CameraQC.check_camera_times"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#ibllib.qc.camera.CameraQC.check_camera_times" title="Permalink to this definition">¶</a></dt>
<dd><p>Check that the number of raw camera timestamps matches the number of video frames</p>
</dd></dl>

<dl class="py method">
<dt id="ibllib.qc.camera.CameraQC.check_resolution">
<code class="sig-name descname">check_resolution</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="../_modules/ibllib/qc/camera.html#CameraQC.check_resolution"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#ibllib.qc.camera.CameraQC.check_resolution" title="Permalink to this definition">¶</a></dt>
<dd><p>Check that the timestamps and video file resolution match what we expect</p>
</dd></dl>

<dl class="py method">
<dt id="ibllib.qc.camera.CameraQC.check_wheel_alignment">
<code class="sig-name descname">check_wheel_alignment</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">tolerance</span><span class="o">=</span><span class="default_value">1, 2</span></em>, <em class="sig-param"><span class="n">display</span><span class="o">=</span><span class="default_value">False</span></em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/ibllib/qc/camera.html#CameraQC.check_wheel_alignment"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#ibllib.qc.camera.CameraQC.check_wheel_alignment" title="Permalink to this definition">¶</a></dt>
<dd><p>Check wheel motion in video correlates with the rotary encoder signal</p>
<p>Check is skipped for body camera videos as the wheel is often obstructed</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><p><strong>tolerance</strong> – maximum absolute offset in frames.  If two values, the maximum value</p>
</dd>
</dl>
<p>is taken as the warning threshold
:param display: if true, the wheel motion energy is plotted against the rotary encoder
:returns: outcome string, frame offset</p>
</dd></dl>

<dl class="py method">
<dt id="ibllib.qc.camera.CameraQC.check_position">
<code class="sig-name descname">check_position</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">hist_thresh</span><span class="o">=</span><span class="default_value">75, 80</span></em>, <em class="sig-param"><span class="n">pos_thresh</span><span class="o">=</span><span class="default_value">10, 15</span></em>, <em class="sig-param"><span class="n">metric</span><span class="o">=</span><span class="default_value">5</span></em>, <em class="sig-param"><span class="n">display</span><span class="o">=</span><span class="default_value">False</span></em>, <em class="sig-param"><span class="n">test</span><span class="o">=</span><span class="default_value">False</span></em>, <em class="sig-param"><span class="n">roi</span><span class="o">=</span><span class="default_value">None</span></em>, <em class="sig-param"><span class="n">pct_thresh</span><span class="o">=</span><span class="default_value">True</span></em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/ibllib/qc/camera.html#CameraQC.check_position"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#ibllib.qc.camera.CameraQC.check_position" title="Permalink to this definition">¶</a></dt>
<dd><p>Check camera is positioned correctly
For the template matching zero-normalized cross-correlation (default) should be more
robust to exposure (which we’re not checking here).  The L2 norm (TM_SQDIFF) should
also work.</p>
<p>If display is True, the template ROI (pick hashed) is plotted over a video frame,
along with the threshold regions (green solid).  The histogram correlations are plotted
and the full histogram is plotted for one of the sample frames and the reference frame.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>hist_thresh</strong> – The minimum histogram cross-correlation threshold to pass (0-1).</p></li>
<li><p><strong>pos_thresh</strong> – The maximum number of pixels off that the template matcher may be off
by. If two values are provided, the lower threshold is treated as a warning boundary.</p></li>
<li><p><strong>metric</strong> – The metric to use for template matching.</p></li>
<li><p><strong>display</strong> – If true, the results are plotted</p></li>
<li><p><strong>test</strong> – If true a reference frame instead of the frames in frame_samples.</p></li>
<li><p><strong>roi</strong> – A tuple of indices for the face template in the for ((y1, y2), (x1, x2))</p></li>
<li><p><strong>pct_thresh</strong> – If true, the thresholds are treated as percentages</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt id="ibllib.qc.camera.CameraQC.check_focus">
<code class="sig-name descname">check_focus</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">n</span><span class="o">=</span><span class="default_value">20</span></em>, <em class="sig-param"><span class="n">threshold</span><span class="o">=</span><span class="default_value">100, 6</span></em>, <em class="sig-param"><span class="n">roi</span><span class="o">=</span><span class="default_value">False</span></em>, <em class="sig-param"><span class="n">display</span><span class="o">=</span><span class="default_value">False</span></em>, <em class="sig-param"><span class="n">test</span><span class="o">=</span><span class="default_value">False</span></em>, <em class="sig-param"><span class="n">equalize</span><span class="o">=</span><span class="default_value">True</span></em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/ibllib/qc/camera.html#CameraQC.check_focus"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#ibllib.qc.camera.CameraQC.check_focus" title="Permalink to this definition">¶</a></dt>
<dd><p>Check video is in focus
Two methods are used here: Looking at the high frequencies with a DFT and
applying a Laplacian HPF and looking at the variance.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<ul class="simple">
<li><p>Both methods are sensitive to noise (Laplacian is 2nd order filter).</p></li>
<li><p>The thresholds for the fft may need to be different for the left/right vs body as
the distribution of frequencies in the image is different (e.g. the holder
comprises mostly very high frequencies).</p></li>
<li><p>The image may be overall in focus but the places we care about can still be out of
focus (namely the face).  For this we’ll take an ROI around the face.</p></li>
<li><p>Focus check thrown off by brightness.  This may be fixed by equalizing the histogram
(set equalize=True)</p></li>
</ul>
</div>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>n</strong> – number of frames from frame_samples data to use in check.</p></li>
<li><p><strong>threshold</strong> – the lower boundary for Laplacian variance and mean FFT filtered
brightness, respectively</p></li>
<li><p><strong>roi</strong> – if False, the roi is determined via template matching for the face or body.</p></li>
</ul>
</dd>
</dl>
<p>If None, some set ROIs for face and paws are used.  A list of slices may also be passed.
:param display: if true, the results are displayed
:param test: if true, a set of artificially blurred reference frames are used as the
input.  This can be used to selecting reasonable thresholds.
:param equalize: if true, the histograms of the frames are equalized, resulting in an
increased the global contrast and linear CDF.  This makes check robust to low light
conditions.</p>
</dd></dl>

<dl class="py method">
<dt id="ibllib.qc.camera.CameraQC.find_face">
<code class="sig-name descname">find_face</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">roi</span><span class="o">=</span><span class="default_value">None</span></em>, <em class="sig-param"><span class="n">test</span><span class="o">=</span><span class="default_value">False</span></em>, <em class="sig-param"><span class="n">metric</span><span class="o">=</span><span class="default_value">5</span></em>, <em class="sig-param"><span class="n">refs</span><span class="o">=</span><span class="default_value">None</span></em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/ibllib/qc/camera.html#CameraQC.find_face"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#ibllib.qc.camera.CameraQC.find_face" title="Permalink to this definition">¶</a></dt>
<dd><p>Use template matching to find face location in frame
For the template matching zero-normalized cross-correlation (default) should be more
robust to exposure (which we’re not checking here).  The L2 norm (TM_SQDIFF) should
also work.  That said, normalizing the histograms works best.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>roi</strong> – A tuple of indices for the face template in the for ((y1, y2), (x1, x2))</p></li>
<li><p><strong>test</strong> – If True the template is matched against frames that come from the same session</p></li>
<li><p><strong>metric</strong> – The metric to use for template matching</p></li>
<li><p><strong>refs</strong> – An array of frames to match the template to</p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p>(y1, y2), (x1, x2)</p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt id="ibllib.qc.camera.CameraQC.load_reference_frames">
<em class="property">static </em><code class="sig-name descname">load_reference_frames</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">side</span></em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/ibllib/qc/camera.html#CameraQC.load_reference_frames"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#ibllib.qc.camera.CameraQC.load_reference_frames" title="Permalink to this definition">¶</a></dt>
<dd><p>Load some reference frames for a given video</p>
<p>The reference frames are from sessions where the camera was well positioned. The
frames are in qc/reference, one file per camera, only one channel per frame.  The
session eids can be found in qc/reference/frame_src.json</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><p><strong>side</strong> – Video label, e.g. ‘left’</p>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p>numpy array of frames with the shape (n, h, w)</p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt id="ibllib.qc.camera.CameraQC.imshow">
<em class="property">static </em><code class="sig-name descname">imshow</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">frame</span></em>, <em class="sig-param"><span class="n">ax</span><span class="o">=</span><span class="default_value">None</span></em>, <em class="sig-param"><span class="n">title</span><span class="o">=</span><span class="default_value">None</span></em>, <em class="sig-param"><span class="o">**</span><span class="n">kwargs</span></em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/ibllib/qc/camera.html#CameraQC.imshow"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#ibllib.qc.camera.CameraQC.imshow" title="Permalink to this definition">¶</a></dt>
<dd><p>plt.imshow with some convenient defaults for greyscale frames</p>
</dd></dl>

</dd></dl>

<dl class="py function">
<dt id="ibllib.qc.camera.data_for_keys">
<code class="sig-name descname">data_for_keys</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">keys</span></em>, <em class="sig-param"><span class="n">data</span></em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/ibllib/qc/camera.html#data_for_keys"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#ibllib.qc.camera.data_for_keys" title="Permalink to this definition">¶</a></dt>
<dd><p>Check keys exist in ‘data’ dict and contain values other than None</p>
</dd></dl>

<dl class="py function">
<dt id="ibllib.qc.camera.run_all_qc">
<code class="sig-name descname">run_all_qc</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">session</span></em>, <em class="sig-param"><span class="n">cameras</span><span class="o">=</span><span class="default_value">'left', 'right', 'body'</span></em>, <em class="sig-param"><span class="o">**</span><span class="n">kwargs</span></em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/ibllib/qc/camera.html#run_all_qc"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#ibllib.qc.camera.run_all_qc" title="Permalink to this definition">¶</a></dt>
<dd><p>Run QC for all cameras
Run the camera QC for left, right and body cameras.
:param session: A session path or eid.
:param update: If True, QC fields are updated on Alyx.
:param cameras: A list of camera names to perform QC on.
:param stream: If true and local video files not available, the data are streamed from
the remote source.
:return: dict of CameraCQ objects</p>
</dd></dl>

</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="ibllib.qc.critical_reasons.html" class="btn btn-neutral float-right" title="ibllib.qc.critical_reasons" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="ibllib.qc.base.html" class="btn btn-neutral float-left" title="ibllib.qc.base" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2020, International Brain Laboratory

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>